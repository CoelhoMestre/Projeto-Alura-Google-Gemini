# -*- coding: utf-8 -*-
"""Projeto Alura + Google Gemini.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1gRhH3uzeI38pkxvFJrwOLw_m-OoC9r7s
"""

# Commented out IPython magic to ensure Python compatibility.
# %pip install -q -U google-generativeai

# Instalar Framework ADK de agentes do Google
!pip install -q google-adk

import os
from google.colab import userdata
from google import genai
from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search
from google.genai import types
from datetime import date
import textwrap
from IPython.display import display, Markdown, HTML
import requests
import warnings
import ipywidgets as widgets
from typing import List, Dict, Any
import re


warnings.filterwarnings("ignore")

# ConfiguraÃ§Ã£o da chave da API do Google
os.environ["GOOGLE_API_KEY"] = userdata.get('GOOGLE_API_KEY')
client = genai.Client()
MODEL_ID = "gemini-2.0-flash"

# FunÃ§Ã£o auxiliar que envia uma mensagem para um agente via Runner e retorna a resposta final
def call_agent(agent: Agent, message_text: str) -> str:
    # Cria um serviÃ§o de sessÃ£o em memÃ³ria
    session_service = InMemorySessionService()
    # Cria uma nova sessÃ£o (vocÃª pode personalizar os IDs conforme necessÃ¡rio)
    session = session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    # Cria um Runner para o agente
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)
    # Cria o conteÃºdo da mensagem de entrada
    content = types.Content(role="user", parts=[types.Part(text=message_text)])

    final_response = ""
    # Itera assincronamente pelos eventos retornados durante a execuÃ§Ã£o do agente
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
          for part in event.content.parts:
            if part.text is not None:
              final_response += part.text
              final_response += "\n"
    return final_response

# FunÃ§Ã£o auxiliar para exibir texto formatado em Markdown no Colab
def to_markdown(text):
  text = text.replace('â€¢', '  *')
  return Markdown(textwrap.indent(text, '> ', predicate=lambda _: True))

#==============================================#
#======= Agente 1: Buscador de ConteÃºdo =======#
#==============================================#
def agente_buscador(conteudo: str) -> str:
    buscador = Agent(
        name="agente_buscador",
        model="gemini-2.0-flash",
        instruction="""
        VocÃª Ã© um assistente de pesquisa especializado em gerar informaÃ§Ãµes para quizzes educativos.
        Utilize a ferramenta google_search no idioma portugues para encontrar conteÃºdo relevante sobre a [disciplina] e o tÃ³pico [conteÃºdo],
        **Verifique se a disciplina tem relaÃ§Ã£o com o conteÃºdo! Por exemplo, se o conteÃºdo for 2Âº guerra mundial de a disciplina for Artes,
        vocÃ© terÃ¡ que relacionar a disciplina com o conteÃºdo** garantindo que as informaÃ§Ãµes sejam adequadas para o nÃ­vel de ensino correspondente.
        Busque por uma visÃ£o geral do tema e identifique atÃ© [10] subtÃ³picos ou conceitos chave importantes.
        Gere um parÃ¡grafo introdutÃ³rio com no mÃ¡ximo [10] frases, apresentando o tema principal de forma clara e concisa
        e mencionando brevemente alguns dos subtÃ³picos encontrados. Utilize uma linguagem acessÃ­vel e destaque a relevÃ¢ncia
        do conteÃºdo para o aprendizado.
        """,
        description="Agente que busca informaÃ§Ãµes no Google",
        tools=[google_search]
    )
    entrada = f"ConteÃºdo: {conteudo}"
    informacoes = call_agent(buscador, entrada)
    return informacoes

#==============================================#
#======= Agente 2: Gerador de Perguntas =======#
#==============================================#
def agente_gerador_quiz(informacoes: str, disciplina: str, turma: str) -> str:
    """Gera as perguntas do quiz (retorna string para revisÃ£o)."""
    gerador = Agent(
        name="agente_gerador_quiz",
        model="gemini-2.0-flash",
        instruction="""
        VocÃª Ã© um especialista em elaboraÃ§Ã£o de perguntas para quizzes educativos. Sua tarefa Ã© analisar as informaÃ§Ãµes
        fornecidas sobre um determinado conteÃºdo da disciplina [disciplina] para a turma [turma].
        Com base nessas informaÃ§Ãµes, formule **apenas 10 possÃ­veis perguntas, nÃ£o pode ter mais** relevantes para o conteÃºdo
        e adequadas ao nÃ­vel de ensino da turma. AtenÃ§Ã£o! as perguntas devem ser de marcar, nÃ£o pode ser resposta escrita.
        Para cada pergunta, apresente a pergunta de forma clara e concisa. **NÃ£o inclua as opÃ§Ãµes de resposta ou a resposta
        correta nesta etapa.**
        Fomate a saÃ­da como uma lista numerada de perguntas, onde cada pergunta aparece em uma nova linha.
        """,
        description="Agente que gera perguntas de quiz",
    )
    entrada = f"InformaÃ§Ãµes: {informacoes}\nDisciplina: {disciplina}\nTurma: {turma}"
    quiz = call_agent(gerador, entrada)
    return quiz

#==============================================#
#======= Agente 3: Revisor de Perguntas =======#
#==============================================#
def agente_revisor_formatador(quiz: str) -> str:
    """Revisa a qualidade das perguntas e formata as questÃµes"""

    revisor = Agent(
        name="agente_revisor",
        model="gemini-2.0-flash",
        instruction="""
        VocÃª Ã© um revisor e seletor de perguntas para quizzes educativos.
        Sua tarefa Ã© analisar a lista de perguntas fornecida, geradas com base no conteÃºdo [conteudo] para
        a disciplina de [disciplina] da turma [turma].
        Para cada pergunta, avalie se ela Ã© clara, concisa, gramaticalmente correta e adequada ao nÃ­vel de ensino da turma.
        Verifique se a pergunta Ã© relevante para o conteÃºdo especificado. ApÃ³s a anÃ¡lise, selecione as perguntas que vocÃª
        considera mais adequadas e de maior qualidade para formar um quiz eficaz para esta turma e conteÃºdo. As perguntas
        selecionadas devem cobrir os aspectos mais importantes do tema.
        A saÃ­da deve ser formatada para ser facilmente lido.
        Adicione numeraÃ§Ã£o para cada pergunta (QuestÃ£o X) e letras (A, B, C, D, E) para cada opÃ§Ã£o de resposta.
        """,
        description="Agente que revisa a qualidade do quiz"
    )
    entrada = f"Quiz: {quiz}"
    quiz_revisado_formatado = call_agent(revisor, entrada)
    return quiz_revisado_formatado

#==============================================#
#======= Agente 4: Formatador de Quiz =========#
#==============================================#
def agente_solucionador(quiz_revisado: str) -> str:
    """Formata o quiz revisado para apresentaÃ§Ã£o."""
    formatador = Agent(
        name="agente_formatador_quiz",
        model="gemini-2.0-flash",
        instruction="""
        VocÃª Ã© um solucionador de quiz.
        VocÃª vai analisar o quiz elaborado e solucionÃ¡-lo, apresentando as opÃ§Ãµes corretas de cada questÃ£o anteriormente elaborada.
        """,
        description="Agente que formata o quiz revisado para apresentaÃ§Ã£o"
    )
    entrada = f"Quiz Revisado: {quiz_revisado}"
    quiz_solucionado = call_agent(formatador, entrada)
    return quiz_solucionado

#==============================================#
#======= Agente 5: Explicador de Quiz =========#
#==============================================#
def agente_gerador_explicacoes(quiz_revisado: str, quiz_solucionado: str, conteudo: str) -> str:
    """Gera explicaÃ§Ãµes detalhadas para as respostas corretas e incorretas do quiz."""
    gerador_explicacoes = Agent(
        name="agente_gerador_explicacoes",
        model="gemini-2.0-flash",
        instruction=f"""
        VocÃª Ã© um especialista em fornecer explicaÃ§Ãµes detalhadas para quizzes educacionais.
        Com base no quiz revisado: "{quiz_revisado}" e na sua soluÃ§Ã£o: "{quiz_solucionado}",
        para o conteÃºdo de "{conteudo}", sua tarefa Ã© gerar explicaÃ§Ãµes claras e concisas para cada questÃ£o.

        Para cada questÃ£o, vocÃª deve:
        1. Indicar qual Ã© a alternativa correta.
        2. Explicar o raciocÃ­nio por trÃ¡s da resposta correta, detalhando o conceito ou princÃ­pio envolvido.
        3. Para cada uma das alternativas incorretas, explicar por que elas estÃ£o erradas, identificando o erro conceitual ou a informaÃ§Ã£o incorreta que elas apresentam.
        4. Mantenha um tom didÃ¡tico e acessÃ­vel, visando a compreensÃ£o do aluno.

        Formato de saÃ­da desejado:
        QuestÃ£o 1:
        - Correta: [Letra da alternativa correta] - [ExplicaÃ§Ã£o da resposta correta]
        - Incorretas:
          - [Letra da alternativa incorreta]: [ExplicaÃ§Ã£o de por que estÃ¡ incorreta]
          - [Letra da alternativa incorreta]: [ExplicaÃ§Ã£o de por que estÃ¡ incorreta]
          - [Letra da alternativa incorreta]: [ExplicaÃ§Ã£o de por que estÃ¡ incorreta]

        QuestÃ£o 2:
        - Correta: ...
        - Incorretas:
          - ...
          - ...
          - ...

        ... e assim por diante para todas as questÃµes do quiz.
        """,
        description="Agente que gera explicaÃ§Ãµes detalhadas para as respostas do quiz"
    )
    entrada = f"Quiz Revisado: {quiz_revisado}\nSoluÃ§Ã£o do Quiz: {quiz_solucionado}\nConteÃºdo: {conteudo}"
    explicacoes_detalhadas = call_agent(gerador_explicacoes, entrada)
    return explicacoes_detalhadas

#==============================================#
#======= Agente 6: Indicador de Fontes ========#
#==============================================#
def agente_indicador_fontes(quiz_original: str, conteudo_pesquisado: str) -> str:
    """Sugere as possÃ­veis fontes de onde as questÃµes do quiz podem ter sido elaboradas."""
    sugestor_fontes = Agent(
        name="agente_sugestor_fontes",
        model="gemini-2.0-flash",
        instruction=f"""
        VocÃª Ã© um especialista em sugerir fontes para a elaboraÃ§Ã£o de quizzes educacionais.
        Com base no seguinte quiz original: "{quiz_original}" e no conteÃºdo pesquisado: "{conteudo_pesquisado}",
        sua tarefa Ã© indicar as fontes provÃ¡veis que um professor ou criador de conteÃºdo utilizaria para elaborar essas questÃµes.
        Liste as sugestÃµes de fontes, como:
        - Livros didÃ¡ticos relevantes para "{conteudo_pesquisado}" e a disciplina relacionada.
        - Sites educacionais confiÃ¡veis que abordam o tema.
        - Artigos acadÃªmicos ou de divulgaÃ§Ã£o cientÃ­fica (se aplicÃ¡vel ao nÃ­vel do quiz).
        - Provas anteriores de vestibulares, concursos ou avaliaÃ§Ãµes similares.
        - Materiais de estudo e resumos sobre "{conteudo_pesquisado}".
        Seja especÃ­fico ao sugerir tipos de materiais e possÃ­veis palavras-chave para encontrar essas fontes.
        """,
        description="Agente que sugere possÃ­veis fontes para a elaboraÃ§Ã£o do quiz"
    )
    entrada = f"Quiz Original: {quiz_original}\nConteÃºdo Pesquisado: {conteudo_pesquisado}"
    fontes_sugeridas = call_agent(sugestor_fontes, entrada)
    return fontes_sugeridas

import ipywidgets as widgets
from IPython.display import display

def quiz_educacional():
    """Coleta dados do professor: disciplina, turma, conteÃºdo e inicia o fluxo."""

    titulo = widgets.HTML(
        value="""
        <h1 style='font-size: 2em; font-weight: bold; text-align:center;'>ğŸ‰ Bem-vindo(a) ao Prof+! ğŸ¤–</h1>
        <h2 style='font-size: 1.5em; text-align:center;'>âœ¨ Seu assistente para criar quizzes incrÃ­veis! âœ¨</h2>
        <p style='font-size: 1.2em; text-align:center;'>ğŸ“š Vamos comeÃ§ar a elaborar as questÃµes para seus alunos! ğŸš€</p>
        <p style='font-size: 1.2em; text-align:center;'>Por favor, preencha os campos abaixo com as informaÃ§Ãµes necessÃ¡rias:</p>
        """
    )


    disciplina_input = widgets.Text(description="ğŸ“š Disciplina:")
    disciplina_input.layout.width = '300px'

    turma_input = widgets.Text(description="ğŸ§‘â€ğŸ« Turma (Ano):")
    turma_input.layout.width = '300px'

    conteudo_input = widgets.Text(description="ğŸ“ ConteÃºdo:")
    conteudo_input.layout.width = '300px'


    button = widgets.Button(description="ğŸ’¡ Gerar Quiz!", button_style='success')
    button.layout.width = '300px'

    output = widgets.Output()


    input_widgets = widgets.VBox([
        disciplina_input,
        turma_input,
        conteudo_input,
        button
    ])
    input_widgets.layout.align_items = 'center'

    def on_button_clicked(b):
        with output:
            output.clear_output()
            disciplina = disciplina_input.value
            turma = turma_input.value
            conteudo = conteudo_input.value

            if not disciplina or not turma or not conteudo:
                print("âš ï¸ Por favor, preencha todos os campos para prosseguir! âš ï¸")
            else:
                try:
                    print("\nâœ… InformaÃ§Ãµes recebidas! Preparando o quiz... ğŸ¤“")
                    print(f"Disciplina: {disciplina}, Turma: {turma}, ConteÃºdo: {conteudo}\n")

                    print("#" * 120)
                    print("âœ¨ Iniciando o processo de geraÃ§Ã£o do quiz... âœ¨\n")
                    print("#" * 120)
                    informacoes = agente_buscador(conteudo)
                    print("\n--- ğŸ” Resultado do Agente 1 (Buscador) ---\n")
                    print("--- â„¹ï¸ InformaÃ§Ãµes Encontradas ---")
                    print(informacoes)
                    print("#" * 120)

                    print("\nâœ¨ Gerando as perguntas... âœï¸\n")
                    print("#" * 120)
                    quiz = agente_gerador_quiz(informacoes, disciplina, turma)
                    print("\n--- ğŸ“ Resultado do Agente 2 (Gerador) ---\n")
                    print("--- â“ Quiz Gerado ---")
                    print(quiz)
                    print("#" * 120)

                    print("\nâœ¨ Revisando e formatando as perguntas... ğŸ§\n")
                    print("#" * 120)
                    quiz_revisado_formatado = agente_revisor_formatador(quiz)
                    print("\n--- ğŸ“ Resultado do Agente 3 (Revisor e Formatador) ---\n")
                    print("--- âœ… Quiz Revisado e Formatado ---")
                    print(quiz_revisado_formatado)
                    print("#" * 120)

                    print("\nâœ¨ Solucionando o quiz... ğŸ’¡\n")
                    print("#" * 120)
                    quiz_solucionado = agente_solucionador(quiz_revisado_formatado)
                    print("\n--- ğŸ“ Resultado do Agente 4 (Solucionador) ---\n")
                    print("--- ğŸ¯ Quiz Solucionado ---")
                    print(quiz_solucionado)
                    print("#" * 120)

                    print("\nâœ¨ Gerando explicaÃ§Ãµes detalhadas... ğŸ§\n")
                    print("#" * 120)
                    explicacoes = agente_gerador_explicacoes(quiz_revisado_formatado, quiz_solucionado, conteudo)
                    print("\n--- ğŸ“ Resultado do Agente 5 (Gerador de ExplicaÃ§Ãµes Detalhadas) ---\n")
                    print("--- ğŸ’¡ ExplicaÃ§Ãµes Detalhadas ---")
                    print(explicacoes)
                    print("#" * 120)

                    print("\nâœ¨ Sugerindo as possÃ­veis fontes... ğŸ“š\n")
                    print("#" * 120)
                    fontes = agente_indicador_fontes(quiz, conteudo)
                    print("\n--- ğŸ“š Resultado do Agente 6 (SugestÃ£o de Fontes) ---\n")
                    print("--- ğŸ” SugestÃµes de Fontes ---")
                    print(fontes)
                    print("#" * 120)

                    print("\nğŸ‰ Quiz completo! Pronto para usar! ğŸ‰\n")

                except Exception as e:
                    print(f"ğŸš¨ Ocorreu um erro: {e} ğŸš¨")

    button.on_click(on_button_clicked)


    interface = widgets.VBox([
        titulo,
        input_widgets,
        output
    ])
    interface.layout.align_items = 'center'

    display(interface)

# Fluxo Principal
quiz_educacional()



